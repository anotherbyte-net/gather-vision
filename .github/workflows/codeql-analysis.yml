name: CodeQL

on:
  push:
    branches:
      - main
  pull_request:
    # The branches below must be a subset of the branches above
    branches:
      - main
  schedule:
    - cron: '42 13 * * 1'

defaults:
  run:
    shell: bash

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        language:
          - 'python'
        python-version:
          - '3.9'
          - '3.10'
        poetry-version:
          - '1.1.12'

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          # this caches the pip global cache
          cache: 'pip'
          cache-dependency-path: '**/poetry.lock'

      - name: Cache Python virtual environment
        uses: actions/cache@v2
        with:
          path: |
            .venv
          key: python-venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('poetry.lock') }}
          restore-keys: |
            python-venv-${{ runner.os }}-${{ matrix.python-version }}
            python-venv-${{ runner.os }}
            python-venv

      - name: Install Python Poetry
        run: |
          curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/install-poetry.py | python -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create and populate Python virtual environment
        run: |
          if [[ ! -d $PWD/.venv ]]; then
            python -m venv $PWD/.venv
          fi
          poetry config virtualenvs.in-project true
          poetry run python -m pip install --upgrade pip setuptools wheel
          poetry install --remove-untracked
          # Set the `CODEQL-PYTHON` environment variable to the Python executable that includes the dependencies
          echo "CODEQL_PYTHON=$PWD/.venv/bin/python" >> $GITHUB_ENV

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: ${{ matrix.language }}
          setup-python-dependencies: false

      - name: Autobuild
        uses: github/codeql-action/autobuild@v1

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1
